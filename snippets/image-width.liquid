{%- unless image-width == blank -%}
  {%- if image-width.aspect_ratio < 1.0 -%}
    {%- assign maximum_width = width | times: image-width.aspect_ratio -%}
    {%- if image-width.height <= width -%}
      {%- assign maximum_width = image-width.width -%}
    {%- endif -%}
  {%- else -%}
    {%- if image-width.width <= width -%}
      {%- assign maximum_width = image-width.width -%}
    {%- else -%}
      {%- assign maximum_width = width -%}
    {%- endif -%}
  {%- endif -%}
{%- else -%}
  {%- assign maximum_width = width -%}
{%- endunless -%}
{{- maximum_width -}}
